# Аудит проекта Pressograph

## Краткое описание
Pressograph — платформа для визуализации и обмена результатами гидравлических испытаний. Кодовая база опирается на Next.js 15.5.6, React 19.2, TypeScript 5.9, Drizzle ORM и PostgreSQL 18, при поддержке Valkey (Redis) и контейнерной инфраструктуры на Podman/Trafik.

## Текущее состояние
### Инфраструктура и окружение
- Контейнерное окружение и скрипты для девелопмента полностью описаны и работают через `deploy/scripts` и `podman-compose` (см. docs/DEVELOPMENT.md).
- Подготовлены конфигурации для PostgreSQL, Valkey и Traefik с упором на безопасность и ресурсы; есть отдельный спринт по hardening (sprints/infrastructure-hardening-20251103).
- В репозитории присутствуют артефакты сборки (`.next`, `node_modules`, `.pnpm-store`), что усложняет контроль версий и может мешать разработке.

### Бэкенд и данные
- Настроено подключение к PostgreSQL через Drizzle (`src/lib/db/index.ts`), описаны подробные схемы таблиц, включая сущности NextAuth и доменную модель (папка `src/lib/db/schema`).
- В `drizzle/` лежат SQL-миграции, но нет признаков того, что они прогнаны в dev-окружении (следует подтвердить через `pnpm db:ls` / `pnpm db:migrate`).
- Реализован health-check REST endpoint (`src/app/api/health/route.ts`), проверяющий состояние базы и Valkey.

### Аутентификация и безопасность
- Конфигурация NextAuth (`src/lib/auth/config.ts`) по-прежнему использует `PrismaAdapter`, тогда как проект перешёл на Drizzle ORM; часть логики (CredentialsProvider) закомментирована и требует переписывания на Drizzle.
- Схемы таблиц NextAuth на Drizzle присутствуют, что подтверждает намерение мигрировать, но адаптер пока не переключён; это блокирует полноценную авторизацию.

### Фронтенд и UI
- Главная страница (`src/app/page.tsx`) — статичный плейсхолдер без реальных экранов приложения и с устаревшими данными о стеке (указан Next.js 16.0.1).
- Базовая структура `src/components` есть, но из «ui» реализована только кнопка (`button.tsx`); тема, layout и навигация ещё не собраны.
- `src/app/layout.tsx` не подключает провайдеры (QueryClient, ThemeProvider), хотя упрощённый провайдер лежит в `src/components/providers.tsx`. Это объясняет временное отключение функциональности (см. комментарии в коде и NEXT_STEPS.md).
- Tailwind переменные и токены тем оформлены (`src/styles/globals.css`), однако отсутствует клиентская логика выбора и хранения темы.

### Наблюдаемость и DevOps
- В `instrumentation.ts` предусмотрена интеграция OpenTelemetry и обнаружены планы на Uptrace/VictoriaMetrics (docs/OBSERVABILITY*), но фактическое включение завернуто в флаг `OTEL_ENABLED` и по умолчанию отключено.

### Тесты и качество
- Структура каталогов `tests/{unit,integration,e2e}` создана, однако файлов нет — автоматические тесты пока не реализованы.
- Настроены команды `pnpm lint`, `pnpm type-check`, `pnpm test`, но их результат неизвестен без запуска.

### Документация и планирование
- Документация богата и актуальна: `docs/index.md`, `docs/DEVELOPMENT.md`, `NEXT_STEPS.md`, файловые отчёты из предыдущих спринтов (`sprints/sprint-01`, `sprints/sprint-02`).
- План Sprint 1 выполнен на ~33%, Sprint 2 описывает задачи по аутентификации и UI, а дополнительный инфраструктурный спринт фиксирует меры по безопасности.

### GitHub активность
- В трекере 22 открытых и 36 закрытых issues; свежие задачи (#55–#58, #45–#46, #37–#39) сконцентрированы на инфраструктуре (Uptrace/VictoriaMetrics, Traefik, Drizzle ORM) и фронтенд-долге (тема и NextAuth).
- Открыто 12 активных milestones, ближайшие — `Sprint 2: Infrastructure Hardening` (дедлайн 2025-11-09, 3 открытых issue) и `Sprint 4: UI/UX Redesign & Accessibility` (2025-11-14, 3 закрытых / 2 открытых). Закрытых milestones пока нет, что указывает на сдвиг расписания.
- Недавно закрылся блок инфраструктурных задач (#51–#54) по сети, лимитам ресурсов и БД/Valkey, что подтверждает завершение hardening-спринта.
- Последние 10 коммитов на `main` пришлись на 2025-10-31 — 2025-11-03 и выполнены пользователем `KaiAutomate`: архитектурный редизайн, миграция на Next.js, настройка Observability и попытка внедрить TanStack Query/Zustand. Локальная копия отстаёт (HEAD `9cb2cb73`), поэтому часть заявленных в истории функций ещё не отражена в кодовой базе.

## Что стоит исправить в первую очередь
1. **Вычистить репозиторий от артефактов**: исключить `.next/`, `node_modules/`, `.pnpm-store/` из git и обновить `.gitignore` при необходимости.
2. **Переключить NextAuth на Drizzle**: заменить `PrismaAdapter` на `@auth/drizzle-adapter`, реализовать недостающие запросы и вернуть CredentialsProvider либо OAuth-потоки в рабочее состояние.
3. **Обновить главную страницу и метаданные**: привести `src/app/page.tsx` и сопутствующий контент к фактической версии стека (Next.js 15.5.6) и описать реальное состояние продукта.
4. **Вернуть провайдеры в layout**: интегрировать `SimpleQueryProvider`/полноценный QueryClient и будущий ThemeProvider в `src/app/layout.tsx`, восстановив планы из NEXT_STEPS.md.
5. **Настроить и прогнать миграции**: убедиться, что SQL из `drizzle/` применён, и добавить автоматическую проверку в CI/dev (`pnpm db:push` + smoke-тесты).
6. **Определить минимальный набор тестов**: начать с unit-тестов для утилит (`src/lib/utils`) и интеграционных сценариев health-check/аутентификации.

## Рекомендации по дальнейшим шагам
### Короткий горизонт (1-2 недели)
- Закрыть технический долг Sprint 1: сборка Next.js без ошибок, аутентификация с Drizzle, полноценный Query/Theme провайдер.
- Реализовать базовый UI-каркас (layout, навигация, хедер/сайдбар) и подключить Zustand-хранилище согласно NEXT_STEPS.md.
- Настроить автоматический прогон `lint`/`type-check`/`vitest` в контейнере и описать в документации команду проверки.

### Среднесрочно (3-5 недель)
- Создать набор многоразовых UI-компонентов (формы, карточки, таблицы), добавить сохранение пользовательских предпочтений (user_preferences) и связь с темой.
- Завершить observability-стек: включить OpenTelemetry с экспортом в Uptrace/VictoriaMetrics и проверить алертинг.
- Подготовить e2e-сценарии (аутентификация, создание испытания, экспорт отчёта) и интегрировать их в CI.

### Дальше по roadmap
- Развернуть публичный share-flow (ограничение по токенам и сроку действия) согласно функциональным требованиям.
- Проработать RBAC и админ-дэшборд на основе существующих схем `users`, `organizations`, `projects`.
- Организовать выпускные процедуры: процесс релизов, changelog и автоматизированный деплой через Podman/Traefik.

---
Отчёт подготовлен для быстрого ввода новой команды в проект; источники: `package.json`, `docs/index.md`, `docs/DEVELOPMENT.md`, `NEXT_STEPS.md`, `sprints/sprint-01`, `sprints/infrastructure-hardening-20251103`, `src/app`, `src/lib`, GitHub GraphQL (issues, milestones, commits).
