# =============================================================================
# Uptrace Configuration for Pressograph
# =============================================================================
# Complete reference: https://uptrace.dev/get/hosted/config
#
# This configuration file uses the official Uptrace YAML format.
# Environment-specific values are hardcoded here, while secrets are passed
# via docker-compose environment variables to the Uptrace container itself.
# =============================================================================

# -----------------------------------------------------------------------------
# Service Configuration
# -----------------------------------------------------------------------------
service:
  env: development      # Environment: development, production, hosted
  secret: changeme-in-production  # Cryptographic secret key (OVERRIDE VIA ENV)

# -----------------------------------------------------------------------------
# Site Configuration
# -----------------------------------------------------------------------------
site:
  # Primary URL where users access the Uptrace UI and API
  url: https://dev-uptrace.infra4.dev

  # Dedicated URL for telemetry data ingestion (OTLP endpoints)
  # Format: url?grpc=port
  ingest_url: https://dev-uptrace.infra4.dev?grpc=14317

# -----------------------------------------------------------------------------
# Network Listeners
# -----------------------------------------------------------------------------
listen:
  # HTTP server (OTLP/HTTP API, REST API, Web UI)
  http:
    addr: :80  # Internal port (mapped to 14318 in compose)

  # gRPC server (OTLP/gRPC API)
  grpc:
    addr: :4317  # Internal port (mapped to 14317 in compose)

# -----------------------------------------------------------------------------
# Bootstrap Data (Initial Setup)
# -----------------------------------------------------------------------------
seed_data:
  update: true  # Update existing resources
  delete: false # Don't delete resources

  # Default admin user
  users:
    - key: admin_user
      name: Pressograph Admin
      email: admin@pressograph.local
      password: admin  # CHANGE THIS IMMEDIATELY
      email_confirmed: true

  # API tokens for programmatic access
  user_tokens:
    - key: admin_token
      user_key: admin_user
      token: admin_secret_token  # CHANGE THIS

  # Default organization
  orgs:
    - key: pressograph_org
      name: Pressograph

  # Organization membership
  org_users:
    - key: admin_org_user
      org_key: pressograph_org
      user_key: admin_user
      role: owner

  # Default project
  projects:
    - key: pressograph_dev
      name: Pressograph Development
      org_key: pressograph_org

  # Project tokens for OTLP ingestion
  project_tokens:
    - key: dev_token
      project_key: pressograph_dev
      token: project1_secret_token  # CHANGE THIS - used in OTLP DSN

  # Project user permissions
  project_users:
    - key: admin_project_user
      project_key: pressograph_dev
      org_user_key: admin_org_user
      perm_level: admin

# -----------------------------------------------------------------------------
# ClickHouse Database Configuration
# -----------------------------------------------------------------------------
ch_cluster:
  cluster: uptrace1
  replicated: false
  distributed: false

  shards:
    - replicas:
        - addr: clickhouse:9000
          database: uptrace
          user: uptrace
          password: uptracepassword  # OVERRIDE VIA ENV: CLICKHOUSE_PASSWORD

          dial_timeout: 3s
          write_timeout: 5s
          max_retries: 3
          max_execution_time: 30s

# -----------------------------------------------------------------------------
# PostgreSQL Database Configuration
# -----------------------------------------------------------------------------
pg:
  addr: postgres-uptrace:5432
  user: uptrace
  password: uptracepassword  # OVERRIDE VIA ENV: POSTGRES_PASSWORD
  database: uptrace

# -----------------------------------------------------------------------------
# Redis Cache / Task Queue Backend
# -----------------------------------------------------------------------------
redis_cache:
  addrs:
    1: uptrace-valkey:6379
  username: ""  # OVERRIDE VIA ENV if auth enabled
  password: ""
  db: 0

# -----------------------------------------------------------------------------
# ClickHouse Schema Configuration
# -----------------------------------------------------------------------------
ch_schema:
  compression: ZSTD(1)

  # Storage policies (use default for single-node setup)
  spans_index: { storage_policy: default }
  spans_data: { storage_policy: default }
  span_links: { storage_policy: default }
  logs_index: { storage_policy: default }
  logs_data: { storage_policy: default }
  events_index: { storage_policy: default }
  events_data: { storage_policy: default }
  metrics: { storage_policy: default }

# -----------------------------------------------------------------------------
# Telemetry Data Processing
# -----------------------------------------------------------------------------
# Performance tuning for spans, logs, and metrics ingestion
spans:
  # Uncomment to customize performance parameters
  # max_threads: 10
  # max_insert_size: 10000
  # max_buffered_records: 100000

span_links:
  # Uncomment to disable span links if not needed
  # disabled: true

logs:
  # Uncomment to customize performance parameters
  # max_threads: 10
  # max_insert_size: 10000
  # max_buffered_records: 100000

events:
  # Uncomment to customize performance parameters
  # max_threads: 10
  # max_insert_size: 10000
  # max_buffered_records: 100000

metrics:
  # Uncomment to customize performance parameters
  # max_threads: 10
  # max_insert_size: 10000
  # max_buffered_records: 100000
  # max_cumulative_timeseries: 1000000

# -----------------------------------------------------------------------------
# Query & Performance Limits
# -----------------------------------------------------------------------------
trace:
  # Maximum number of spans returned per query
  # query_limit: 200000
  # max_memory_usage_bytes: 200000000

# -----------------------------------------------------------------------------
# Feature Modules
# -----------------------------------------------------------------------------
alerting:
  # Uncomment to disable alerting system
  # disabled: true

service_graph:
  # Uncomment to disable service graph generation
  # disabled: true

sourcemaps:
  # Uncomment to disable JavaScript sourcemap processing
  # disabled: true

# -----------------------------------------------------------------------------
# External Services
# -----------------------------------------------------------------------------
self_monitoring:
  # Uptrace monitors itself and sends telemetry to this DSN
  # disabled: true
  dsn: http://project1_secret_token@uptrace:80?grpc=4317

telegram:
  # Telegram bot token for notifications
  bot_token: ''

# -----------------------------------------------------------------------------
# System Configuration
# -----------------------------------------------------------------------------
logging:
  # Log level: DEBUG, INFO, WARN, ERROR
  level: INFO

license:
  # Premium license key (optional)
  key: ''
