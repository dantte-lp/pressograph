name: pressograph-dev

# Compose Spec 2025 - Podman Compose compatible
# No version field required per Compose Specification

services:
  workspace:
    container_name: pressograph-dev-workspace
    build:
      context: ../..
      dockerfile: deploy/containerfiles/Containerfile.dev
    image: pressograph-dev:latest
    hostname: pressograph-dev
    ports:
      - "3000:3000"      # Next.js dev server (keep for local access)
      - "5555:5555"      # Drizzle Studio direct access
    volumes:
      # Bind mount весь проект (используем абсолютный путь)
      - type: bind
        source: /opt/projects/repositories/pressograph
        target: /workspace
        bind:
          propagation: rslave
      # Named volumes для производительности
      - node_modules:/workspace/node_modules
      - next_cache:/workspace/.next
      - pnpm_store:/home/developer/.local/share/pnpm/store
    environment:
      # Core application
      NODE_ENV: development
      NEXT_TELEMETRY_DISABLED: 1

      # Database
      DATABASE_URL: postgresql://postgres:postgres@db:5432/pressograph

      # Cache
      REDIS_URL: redis://cache:6379

      # Authentication
      NEXTAUTH_URL: http://localhost:3000
      NEXTAUTH_SECRET: dev-secret-change-in-production

      # Observability (OpenTelemetry + VictoriaMetrics)
      OTEL_ENABLED: ${OTEL_ENABLED:-false}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-pressograph-dev}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://victoria-traces:4318}
      VICTORIA_METRICS_URL: ${VICTORIA_METRICS_URL:-http://victoria-metrics:8428}
      VICTORIA_LOGS_URL: ${VICTORIA_LOGS_URL:-http://victoria-logs:9428}
      VICTORIA_TRACES_URL: ${VICTORIA_TRACES_URL:-http://victoria-traces:4318}
    working_dir: /workspace
    stdin_open: true
    tty: true
    depends_on:
      db:
        condition: service_healthy
      cache:
        condition: service_started
    networks:
      frontend:
      backend:
      traefik-public:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    security_opt:
      - no-new-privileges:true
    labels:
      # Podman Compose metadata
      io.podman.compose.project: pressograph-dev
      com.pressograph.service: workspace

      # Traefik configuration
      traefik.enable: "true"
      traefik.docker.network: traefik-public

      # Next.js HTTP Router (redirect to HTTPS)
      traefik.http.routers.pressograph-dev-http.rule: Host(`dev-pressograph.infra4.dev`)
      traefik.http.routers.pressograph-dev-http.entrypoints: http
      traefik.http.routers.pressograph-dev-http.middlewares: pressograph-dev-redirect
      traefik.http.routers.pressograph-dev-http.service: pressograph-dev

      # Next.js HTTPS Router (Certificate from Cloudflare Origin CA)
      traefik.http.routers.pressograph-dev.rule: Host(`dev-pressograph.infra4.dev`)
      traefik.http.routers.pressograph-dev.entrypoints: https
      traefik.http.routers.pressograph-dev.tls: "true"
      traefik.http.routers.pressograph-dev.middlewares: web-development@file
      traefik.http.routers.pressograph-dev.service: pressograph-dev

      # Next.js Service (port 3000)
      traefik.http.services.pressograph-dev.loadbalancer.server.port: "3000"

      # Middleware: HTTPS redirect
      traefik.http.middlewares.pressograph-dev-redirect.redirectscheme.scheme: https
      traefik.http.middlewares.pressograph-dev-redirect.redirectscheme.permanent: "true"

      # Drizzle Studio HTTP Router (redirect to HTTPS)
      traefik.http.routers.drizzle-studio-http.rule: Host(`dbdev-pressograph.infra4.dev`)
      traefik.http.routers.drizzle-studio-http.entrypoints: http
      traefik.http.routers.drizzle-studio-http.middlewares: drizzle-studio-redirect
      traefik.http.routers.drizzle-studio-http.service: drizzle-studio

      # Drizzle Studio HTTPS Router (Certificate from Cloudflare Origin CA)
      traefik.http.routers.drizzle-studio.rule: Host(`dbdev-pressograph.infra4.dev`)
      traefik.http.routers.drizzle-studio.entrypoints: https
      traefik.http.routers.drizzle-studio.tls: "true"
      traefik.http.routers.drizzle-studio.middlewares: web-development@file,drizzle-studio-external-redirect
      traefik.http.routers.drizzle-studio.service: drizzle-studio

      # Drizzle Studio Service (port 5555)
      traefik.http.services.drizzle-studio.loadbalancer.server.port: "5555"

      # Drizzle Studio Redirect Middleware
      traefik.http.middlewares.drizzle-studio-redirect.redirectscheme.scheme: https
      traefik.http.middlewares.drizzle-studio-redirect.redirectscheme.permanent: "true"
      traefik.http.middlewares.drizzle-studio-external-redirect.redirectregex.regex: "^https?://dbdev-pressograph\\.infra4\\.dev/?(.*)"
      traefik.http.middlewares.drizzle-studio-external-redirect.redirectregex.replacement: "https://local.drizzle.studio/?port=5555&host=dbdev-pressograph.infra4.dev&secure=1"
      traefik.http.middlewares.drizzle-studio-external-redirect.redirectregex.permanent: "false"

  db:
    container_name: pressograph-dev-db
    image: postgres:18-trixie
    hostname: pressograph-db
    environment:
      POSTGRES_DB: pressograph
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=en_US.UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
    command: postgres -c config_file=/etc/postgresql/postgresql.conf
    expose:
      - "5432"
    # NO public port mapping for security
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d pressograph"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      backend:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 512M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    labels:
      io.podman.compose.project: pressograph-dev
      com.pressograph.service: database
    shm_size: 256mb

  cache:
    container_name: pressograph-dev-cache
    image: docker.io/valkey/valkey:9-trixie
    hostname: pressograph-cache
    volumes:
      - cache_data:/data
      - ./redis/valkey.conf:/etc/valkey/valkey.conf:ro
    command: valkey-server /etc/valkey/valkey.conf
    expose:
      - "6379"
    # NO public port mapping for security
    networks:
      backend:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
    labels:
      io.podman.compose.project: pressograph-dev
      com.pressograph.service: cache
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ----------------------------------------------------------------------------
  # PostgreSQL Exporter - Metrics for VictoriaMetrics
  # ----------------------------------------------------------------------------
  postgres-exporter:
    container_name: pressograph-dev-postgres-exporter
    image: prometheuscommunity/postgres-exporter:latest
    hostname: postgres-exporter
    environment:
      # PostgreSQL connection string
      DATA_SOURCE_NAME: postgresql://postgres:postgres@db:5432/pressograph?sslmode=disable
      # Disable default metrics that are too verbose
      PG_EXPORTER_DISABLE_DEFAULT_METRICS: "false"
      # Enable extended query metrics
      PG_EXPORTER_EXTEND_QUERY_PATH: /etc/postgres_exporter/queries.yaml
    expose:
      - "9187"
    # NO public port mapping
    networks:
      backend:
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://0.0.0.0:9187/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: 100M
          cpus: '0.2'
        reservations:
          memory: 50M
          cpus: '0.1'
    security_opt:
      - no-new-privileges:true
    labels:
      io.podman.compose.project: pressograph-dev
      com.pressograph.service: postgres-exporter

  # ----------------------------------------------------------------------------
  # Redis/Valkey Exporter - Metrics for VictoriaMetrics
  # ----------------------------------------------------------------------------
  redis-exporter:
    container_name: pressograph-dev-redis-exporter
    image: oliver006/redis_exporter:latest
    hostname: redis-exporter
    environment:
      # Redis connection string
      REDIS_ADDR: redis://cache:6379
      # No password for dev environment
      # REDIS_PASSWORD: ""
      # Include Go runtime metrics
      REDIS_EXPORTER_INCLUDE_GO_RUNTIME_METRICS: "true"
    expose:
      - "9121"
    # NO public port mapping
    networks:
      backend:
    restart: unless-stopped
    depends_on:
      cache:
        condition: service_started
    deploy:
      resources:
        limits:
          memory: 50M
          cpus: '0.1'
        reservations:
          memory: 25M
          cpus: '0.05'
    security_opt:
      - no-new-privileges:true
    labels:
      io.podman.compose.project: pressograph-dev
      com.pressograph.service: redis-exporter

volumes:
  postgres_data:
    name: pressograph-dev-postgres-data
    driver: local
  cache_data:
    name: pressograph-dev-cache-data
    driver: local
  node_modules:
    name: pressograph-dev-node-modules
    driver: local
  next_cache:
    name: pressograph-dev-next-cache
    driver: local
  pnpm_store:
    name: pressograph-dev-pnpm-store
    driver: local

networks:
  frontend:
    name: pressograph-frontend-network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.89.0.0/24
          gateway: 10.89.0.1

  backend:
    name: pressograph-backend-network
    driver: bridge
    internal: true  # No external access - isolated backend
    ipam:
      driver: default
      config:
        - subnet: 10.89.10.0/24
          gateway: 10.89.10.1

  traefik-public:
    external: true
    name: traefik-public
