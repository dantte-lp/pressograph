name: pressograph-dev

# Compose Spec 2025 - Podman Compose compatible
# No version field required per Compose Specification

services:
  workspace:
    container_name: pressograph-dev-workspace
    build:
      context: ../..
      dockerfile: deploy/containerfiles/Containerfile.dev
    image: pressograph-dev:latest
    hostname: pressograph-dev
    ports:
      - "3000:3000"      # Next.js dev server (keep for local access)
      # Port 5555 removed - Traefik accesses Drizzle Studio via internal network
    volumes:
      # Bind mount весь проект (используем абсолютный путь)
      - type: bind
        source: /opt/projects/repositories/pressograph
        target: /workspace
        bind:
          propagation: rslave
      # Named volumes для производительности
      - node_modules:/workspace/node_modules
      - next_cache:/workspace/.next
      - pnpm_store:/home/developer/.local/share/pnpm/store
    environment:
      # Core application
      NODE_ENV: development
      NEXT_TELEMETRY_DISABLED: 1

      # Database
      DATABASE_URL: postgresql://postgres:postgres@db:5432/pressograph

      # Cache
      REDIS_URL: redis://cache:6379

      # Authentication
      NEXTAUTH_URL: http://localhost:3000
      NEXTAUTH_SECRET: dev-secret-change-in-production

      # Observability (OpenTelemetry + VictoriaMetrics)
      OTEL_ENABLED: ${OTEL_ENABLED:-false}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-pressograph-dev}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://victoria-traces:4318}
      VICTORIA_METRICS_URL: ${VICTORIA_METRICS_URL:-http://victoria-metrics:8428}
      VICTORIA_LOGS_URL: ${VICTORIA_LOGS_URL:-http://victoria-logs:9428}
      VICTORIA_TRACES_URL: ${VICTORIA_TRACES_URL:-http://victoria-traces:4318}
    working_dir: /workspace
    stdin_open: true
    tty: true
    depends_on:
      db:
        condition: service_healthy
      cache:
        condition: service_started
    networks:
      - pressograph-dev
      - traefik-public
    restart: unless-stopped
    labels:
      # Podman Compose metadata
      io.podman.compose.project: pressograph-dev
      com.pressograph.service: workspace

      # Traefik configuration
      traefik.enable: "true"
      traefik.docker.network: traefik-public

      # Next.js HTTP Router (redirect to HTTPS)
      traefik.http.routers.pressograph-dev-http.rule: Host(`dev-pressograph.infra4.dev`)
      traefik.http.routers.pressograph-dev-http.entrypoints: http
      traefik.http.routers.pressograph-dev-http.middlewares: pressograph-dev-redirect
      traefik.http.routers.pressograph-dev-http.service: pressograph-dev

      # Next.js HTTPS Router
      traefik.http.routers.pressograph-dev.rule: Host(`dev-pressograph.infra4.dev`)
      traefik.http.routers.pressograph-dev.entrypoints: https
      traefik.http.routers.pressograph-dev.tls: "true"
      traefik.http.routers.pressograph-dev.tls.certresolver: cloudflare
      traefik.http.routers.pressograph-dev.middlewares: web-development@file
      traefik.http.routers.pressograph-dev.service: pressograph-dev

      # Next.js Service (port 3000)
      traefik.http.services.pressograph-dev.loadbalancer.server.port: "3000"

      # Middleware: HTTPS redirect
      traefik.http.middlewares.pressograph-dev-redirect.redirectscheme.scheme: https
      traefik.http.middlewares.pressograph-dev-redirect.redirectscheme.permanent: "true"

      # Drizzle Studio HTTP Router (redirect to HTTPS)
      traefik.http.routers.drizzle-studio-http.rule: Host(`dbdev-pressograph.infra4.dev`)
      traefik.http.routers.drizzle-studio-http.entrypoints: http
      traefik.http.routers.drizzle-studio-http.middlewares: drizzle-studio-redirect
      traefik.http.routers.drizzle-studio-http.service: drizzle-studio

      # Drizzle Studio HTTPS Router
      traefik.http.routers.drizzle-studio.rule: Host(`dbdev-pressograph.infra4.dev`)
      traefik.http.routers.drizzle-studio.entrypoints: https
      traefik.http.routers.drizzle-studio.tls: "true"
      traefik.http.routers.drizzle-studio.tls.certresolver: cloudflare
      traefik.http.routers.drizzle-studio.middlewares: web-development@file
      traefik.http.routers.drizzle-studio.service: drizzle-studio

      # Drizzle Studio Service (port 5555)
      traefik.http.services.drizzle-studio.loadbalancer.server.port: "5555"

      # Drizzle Studio Redirect Middleware
      traefik.http.middlewares.drizzle-studio-redirect.redirectscheme.scheme: https
      traefik.http.middlewares.drizzle-studio-redirect.redirectscheme.permanent: "true"

  db:
    container_name: pressograph-dev-db
    image: postgres:18-trixie
    hostname: pressograph-db
    environment:
      POSTGRES_DB: pressograph
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=en_US.UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d pressograph"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - pressograph-dev
    restart: unless-stopped
    labels:
      io.podman.compose.project: pressograph-dev
      com.pressograph.service: database
    shm_size: 128mb

  cache:
    container_name: pressograph-dev-cache
    image: docker.io/valkey/valkey:9-trixie
    hostname: pressograph-cache
    command: >
      valkey-server
      --save 60 1
      --loglevel warning
    volumes:
      - cache_data:/data
    ports:
      - "6379:6379"
    networks:
      - pressograph-dev
    restart: unless-stopped
    labels:
      io.podman.compose.project: pressograph-dev
      com.pressograph.service: cache
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

volumes:
  postgres_data:
    name: pressograph-dev-postgres-data
    driver: local
  cache_data:
    name: pressograph-dev-cache-data
    driver: local
  node_modules:
    name: pressograph-dev-node-modules
    driver: local
  next_cache:
    name: pressograph-dev-next-cache
    driver: local
  pnpm_store:
    name: pressograph-dev-pnpm-store
    driver: local

networks:
  pressograph-dev:
    name: pressograph-dev-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

  traefik-public:
    external: true
    name: traefik-public
