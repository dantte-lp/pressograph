# ==============================================================================
# PostgreSQL 18 Configuration for Pressograph Development
# ==============================================================================
# Optimized for:
# - Workload: Web application with time-series data
# - RAM: 4GB allocated
# - CPU: 2 cores
# - Storage: SSD
# - Max connections: 100
# ==============================================================================

# -----------------------------------------------------------------------------
# CONNECTION AND AUTHENTICATION
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 100
superuser_reserved_connections = 3

# -----------------------------------------------------------------------------
# MEMORY CONFIGURATION
# -----------------------------------------------------------------------------
# shared_buffers: 25% of available RAM (4GB * 0.25 = 1GB)
shared_buffers = 1GB

# effective_cache_size: 75% of available RAM (estimate of OS cache)
effective_cache_size = 3GB

# work_mem: RAM / max_connections / 10 (for sorting, hashing per query)
work_mem = 10MB

# maintenance_work_mem: For VACUUM, CREATE INDEX, etc.
maintenance_work_mem = 256MB

# -----------------------------------------------------------------------------
# WRITE AHEAD LOG (WAL) CONFIGURATION
# -----------------------------------------------------------------------------
# WAL buffers: -1 = automatic (typically 1/32 of shared_buffers)
wal_buffers = 16MB

# Checkpoint settings for SSD
min_wal_size = 1GB
max_wal_size = 4GB
checkpoint_completion_target = 0.9
checkpoint_timeout = 10min

# WAL archiving (disabled for development)
archive_mode = off

# -----------------------------------------------------------------------------
# QUERY PLANNER CONFIGURATION
# -----------------------------------------------------------------------------
# random_page_cost: Lower for SSD (1.1 vs 4.0 for HDD)
random_page_cost = 1.1

# Sequential vs random I/O cost on SSD
seq_page_cost = 1.0

# effective_io_concurrency: Number of concurrent I/O operations (SSD)
effective_io_concurrency = 200

# Enable parallel query execution
max_parallel_workers_per_gather = 2
max_parallel_workers = 2
max_worker_processes = 2

# -----------------------------------------------------------------------------
# AUTOVACUUM CONFIGURATION
# -----------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 2
autovacuum_naptime = 1min

# Aggressive autovacuum for development (prevent bloat)
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05

# -----------------------------------------------------------------------------
# LOGGING CONFIGURATION (for VictoriaLogs integration)
# -----------------------------------------------------------------------------
# Enable logging collector
logging_collector = on

# Log destination
log_destination = 'stderr'

# Log directory and filename
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# Log rotation
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = off

# What to log
log_min_duration_statement = 1000  # Log queries taking > 1 second
log_line_prefix = '%m [%p] %q%u@%d '
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off
log_error_verbosity = default
log_lock_waits = on
log_statement = 'none'  # none, ddl, mod, all
log_temp_files = 0  # Log all temp files

# Log timezone
log_timezone = 'UTC'

# -----------------------------------------------------------------------------
# STATISTICS AND MONITORING
# -----------------------------------------------------------------------------
# Statistics collection
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# Statement statistics (for pg_stat_statements extension)
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.max = 10000
pg_stat_statements.track = all

# -----------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
# -----------------------------------------------------------------------------
# Timezone
timezone = 'UTC'

# Locale
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# Text search configuration
default_text_search_config = 'pg_catalog.english'

# -----------------------------------------------------------------------------
# SECURITY
# -----------------------------------------------------------------------------
# SSL (disabled for development, enable in production)
ssl = off

# Password encryption
password_encryption = scram-sha-256

# -----------------------------------------------------------------------------
# PERFORMANCE TUNING
# -----------------------------------------------------------------------------
# Shared memory
huge_pages = try

# Background writer (reduce checkpoint spikes)
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# Cost-based vacuum delay (prevent vacuum from overwhelming I/O)
vacuum_cost_delay = 0
vacuum_cost_page_hit = 1
vacuum_cost_page_miss = 10
vacuum_cost_page_dirty = 20
vacuum_cost_limit = 200

# -----------------------------------------------------------------------------
# DEVELOPMENT SPECIFIC SETTINGS
# -----------------------------------------------------------------------------
# Faster synchronization for development (less durability)
# WARNING: Do NOT use in production!
synchronous_commit = on  # Keep on for development safety
fsync = on  # Keep on for data integrity

# JIT compilation (Just-In-Time)
jit = on
jit_above_cost = 100000
jit_inline_above_cost = 500000
jit_optimize_above_cost = 500000

# -----------------------------------------------------------------------------
# TIME-SERIES DATA OPTIMIZATION
# -----------------------------------------------------------------------------
# For tables with time-series data, consider:
# - Partitioning by time range
# - Using TimescaleDB extension (if needed)
# - Appropriate indexes (BRIN for time columns on large tables)

# Enable BRIN index optimization
effective_cache_size = 3GB  # Already set above

# -----------------------------------------------------------------------------
# END OF CONFIGURATION
# -----------------------------------------------------------------------------
