# ==============================================================================
# Pressograph - VictoriaMetrics Observability Stack
# ==============================================================================
# Compose Spec 2025 - Podman Compose compatible
# No version field required per Compose Specification
#
# Provides complete observability with metrics, logs, and traces
#
# Components:
# - VictoriaMetrics: Time-series database for metrics
# - VictoriaLogs: Log aggregation and search
# - VictoriaTraces: Distributed tracing (OpenTelemetry)
# - vmagent: Metrics collection agent
# - vmalert: Alerting and recording rules
# - Grafana: Visualization and dashboards
#
# Usage:
#   task metrics:start  # Start the stack
#   task metrics:stop   # Stop the stack
#   task metrics:logs   # View logs
#
# Access:
#   - Grafana: https://dev-grafana.infra4.dev (admin/admin)
#   - VictoriaMetrics: https://dev-vm.infra4.dev
#   - VictoriaLogs: https://dev-vl.infra4.dev
#   - VictoriaTraces: https://dev-vt.infra4.dev

name: pressograph-victoria

services:
  # ----------------------------------------------------------------------------
  # VictoriaMetrics - Metrics Storage
  # ----------------------------------------------------------------------------
  victoria-metrics:
    image: victoriametrics/victoria-metrics:latest
    container_name: pressograph-victoria-metrics
    expose:
      - "8428"
    # NO public port mapping
    volumes:
      - victoria-metrics-data:/victoria-metrics-data
    command:
      - '--storageDataPath=/victoria-metrics-data'
      - '--httpListenAddr=:8428'
      - '--retentionPeriod=12'  # Keep data for 12 months
      - '--search.maxQueryDuration=120s'
      - '--search.maxConcurrentRequests=8'
      - '--memory.allowedPercent=60'  # Limit memory usage
    networks:
      observability:
      traefik-public:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://0.0.0.0:8428/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      # Podman Compose metadata
      io.podman.compose.project: pressograph-victoria
      com.pressograph.service: victoria-metrics

      # Traefik configuration
      traefik.enable: "true"
      traefik.docker.network: traefik-public

      # HTTPS Router (Certificate from Cloudflare Origin CA)
      traefik.http.routers.victoria-metrics-dev.rule: Host(`dev-vm.infra4.dev`)
      traefik.http.routers.victoria-metrics-dev.entrypoints: https
      traefik.http.routers.victoria-metrics-dev.tls: "true"
      traefik.http.routers.victoria-metrics-dev.tls.domains[0].main: infra4.dev
      traefik.http.routers.victoria-metrics-dev.tls.domains[0].sans: "*.infra4.dev"
      traefik.http.routers.victoria-metrics-dev.middlewares: web-development@file
      traefik.http.routers.victoria-metrics-dev.service: victoria-metrics-dev

      # Service configuration
      traefik.http.services.victoria-metrics-dev.loadbalancer.server.port: "8428"

  # ----------------------------------------------------------------------------
  # VictoriaLogs - Log Storage
  # ----------------------------------------------------------------------------
  victoria-logs:
    image: victoriametrics/victoria-logs:latest
    container_name: pressograph-victoria-logs
    expose:
      - "9428"
    volumes:
      - victoria-logs-data:/victoria-logs-data
    command:
      - '--storageDataPath=/victoria-logs-data'
      - '--httpListenAddr=:9428'
      - '--retentionPeriod=3'  # Keep logs for 3 months
    networks:
      observability:
      traefik-public:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://0.0.0.0:9428/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      # Podman Compose metadata
      io.podman.compose.project: pressograph-victoria
      com.pressograph.service: victoria-logs

      # Traefik configuration
      traefik.enable: "true"
      traefik.docker.network: traefik-public

      # HTTPS Router (Certificate from Cloudflare Origin CA)
      traefik.http.routers.victoria-logs-dev.rule: Host(`dev-vl.infra4.dev`)
      traefik.http.routers.victoria-logs-dev.entrypoints: https
      traefik.http.routers.victoria-logs-dev.tls: "true"
      traefik.http.routers.victoria-logs-dev.tls.domains[0].main: infra4.dev
      traefik.http.routers.victoria-logs-dev.tls.domains[0].sans: "*.infra4.dev"
      traefik.http.routers.victoria-logs-dev.middlewares: web-development@file
      traefik.http.routers.victoria-logs-dev.service: victoria-logs-dev

      # Service configuration
      traefik.http.services.victoria-logs-dev.loadbalancer.server.port: "9428"

  # ----------------------------------------------------------------------------
  # VictoriaTraces - Distributed Tracing (OpenTelemetry)
  # ----------------------------------------------------------------------------
  victoria-traces:
    image: victoriametrics/victoria-traces:latest
    container_name: pressograph-victoria-traces
    expose:
      - "8428"  # HTTP interface
      - "4318"  # OTLP HTTP receiver
      - "4317"  # OTLP gRPC receiver
    volumes:
      - victoria-traces-data:/victoria-traces-data
    command:
      - '--storageDataPath=/victoria-traces-data'
      - '--httpListenAddr=:8428'
      - '--retentionPeriod=1'  # Keep traces for 1 month
    networks:
      observability:
      traefik-public:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://0.0.0.0:8428/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      # Podman Compose metadata
      io.podman.compose.project: pressograph-victoria
      com.pressograph.service: victoria-traces

      # Traefik configuration
      traefik.enable: "true"

      # HTTPS Router for UI (Certificate from Cloudflare Origin CA)
      traefik.http.routers.victoria-traces-dev.rule: Host(`dev-vt.infra4.dev`)
      traefik.http.routers.victoria-traces-dev.entrypoints: https
      traefik.http.routers.victoria-traces-dev.tls: "true"
      traefik.http.routers.victoria-traces-dev.tls.domains[0].main: infra4.dev
      traefik.http.routers.victoria-traces-dev.tls.domains[0].sans: "*.infra4.dev"
      traefik.http.routers.victoria-traces-dev.middlewares: web-development@file
      traefik.http.routers.victoria-traces-dev.service: victoria-traces-dev

      # Service configuration
      traefik.http.services.victoria-traces-dev.loadbalancer.server.port: "8428"

  # ----------------------------------------------------------------------------
  # vmagent - Metrics Collection Agent
  # ----------------------------------------------------------------------------
  vmagent:
    image: victoriametrics/vmagent:latest
    container_name: pressograph-vmagent
    expose:
      - "8429"
    volumes:
      - vmagent-data:/vmagentdata
      - ./victoria/vmagent-config.yml:/etc/vmagent/vmagent.yml:ro
    command:
      # Scrape configuration file
      - '--promscrape.config=/etc/vmagent/vmagent.yml'

      # Remote write endpoint
      - '--remoteWrite.url=http://victoria-metrics:8428/api/v1/write'
      - '--remoteWrite.maxDiskUsagePerURL=1GB'
      - '--remoteWrite.tmpDataPath=/vmagentdata/remotewrite-data'

      # Global scrape settings (override defaults)
      - '--promscrape.config.global.scrape_interval=15s'
      - '--promscrape.config.global.scrape_timeout=10s'

      # External labels (added to all metrics)
      - '--remoteWrite.label=cluster=pressograph-dev'
      - '--remoteWrite.label=environment=development'

      # HTTP API listen address
      - '--httpListenAddr=:8429'

      # Memory limits
      - '--memory.allowedPercent=80'
    networks:
      observability:
      backend:  # Connect to backend to scrape exporters
    restart: unless-stopped
    depends_on:
      - victoria-metrics
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://0.0.0.0:8429/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      io.podman.compose.project: pressograph-victoria
      com.pressograph.service: vmagent

  # ----------------------------------------------------------------------------
  # vmalert - Alerting and Recording Rules
  # ----------------------------------------------------------------------------
  vmalert:
    image: victoriametrics/vmalert:latest
    container_name: pressograph-vmalert
    expose:
      - "8880"
    volumes:
      - ./victoria/vmalert-rules.yml:/etc/vmalert/rules.yml:ro
    command:
      - '--datasource.url=http://victoria-metrics:8428'
      - '--remoteWrite.url=http://victoria-metrics:8428'
      - '--remoteRead.url=http://victoria-metrics:8428'
      - '--rule=/etc/vmalert/rules.yml'
      - '--httpListenAddr=:8880'
      - '--evaluationInterval=15s'
      - '--notifier.blackhole=true'  # Disable alerting for now
    networks:
      observability:
    restart: unless-stopped
    depends_on:
      - victoria-metrics
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://0.0.0.0:8880/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      io.podman.compose.project: pressograph-victoria
      com.pressograph.service: vmalert

  # ----------------------------------------------------------------------------
  # Grafana - Visualization Platform
  # ----------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: pressograph-grafana
    user: "472:472"  # Non-root user (grafana:grafana)
    expose:
      - "3000"
    # NO public port mapping
    environment:
      # Security
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ALLOW_EMBEDDING=true
      - GF_SECURITY_COOKIE_SECURE=true
      - GF_SECURITY_COOKIE_SAMESITE=lax

      # Server settings
      - GF_SERVER_ROOT_URL=https://dev-grafana.infra4.dev
      - GF_SERVER_DOMAIN=dev-grafana.infra4.dev
      - GF_SERVER_ENABLE_GZIP=true

      # Database (use SQLite for simplicity)
      - GF_DATABASE_TYPE=sqlite3
      - GF_DATABASE_PATH=/var/lib/grafana/grafana.db

      # Plugins
      - GF_INSTALL_PLUGINS=grafana-piechart-panel,grafana-clock-panel

      # Analytics (disable for privacy)
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false
      - GF_ANALYTICS_CHECK_FOR_PLUGIN_UPDATES=false

      # Anonymous access (disabled - require login)
      - GF_AUTH_ANONYMOUS_ENABLED=false

      # Logging
      - GF_LOG_MODE=console
      - GF_LOG_LEVEL=info

      # Unified alerting
      - GF_UNIFIED_ALERTING_ENABLED=true
      - GF_ALERTING_ENABLED=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./victoria/grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      observability:
      traefik-public:
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://0.0.0.0:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - victoria-metrics
      - victoria-logs
      - victoria-traces
    labels:
      # Podman Compose metadata
      io.podman.compose.project: pressograph-victoria
      com.pressograph.service: grafana

      # Traefik configuration
      traefik.enable: "true"
      traefik.docker.network: traefik-public

      # HTTPS Router (Certificate from Cloudflare Origin CA)
      traefik.http.routers.grafana-dev.rule: Host(`dev-grafana.infra4.dev`)
      traefik.http.routers.grafana-dev.entrypoints: https
      traefik.http.routers.grafana-dev.tls: "true"
      traefik.http.routers.grafana-dev.tls.domains[0].main: infra4.dev
      traefik.http.routers.grafana-dev.tls.domains[0].sans: "*.infra4.dev"
      traefik.http.routers.grafana-dev.middlewares: web-development@file
      traefik.http.routers.grafana-dev.service: grafana-dev

      # Service configuration
      traefik.http.services.grafana-dev.loadbalancer.server.port: "3000"

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  victoria-metrics-data:
    name: pressograph-victoria-metrics-data
    driver: local
  victoria-logs-data:
    name: pressograph-victoria-logs-data
    driver: local
  victoria-traces-data:
    name: pressograph-victoria-traces-data
    driver: local
  vmagent-data:
    name: pressograph-vmagent-data
    driver: local
  grafana-data:
    name: pressograph-grafana-data
    driver: local

# ==============================================================================
# Networks
# ==============================================================================
networks:
  observability:
    name: pressograph-observability-network
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 10.89.20.0/24
          gateway: 10.89.20.1

  backend:
    external: true
    name: pressograph-backend-network

  traefik-public:
    external: true
    name: traefik-public
