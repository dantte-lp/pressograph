# ==============================================================================
# Pressograph - VictoriaMetrics Observability Stack
# ==============================================================================
# Compose Spec 2025 - Podman Compose compatible
# No version field required per Compose Specification
#
# Provides complete observability with metrics, logs, and traces
#
# Components:
# - VictoriaMetrics: Time-series database for metrics
# - VictoriaLogs: Log aggregation and search
# - VictoriaTraces: Distributed tracing (OpenTelemetry)
# - vmagent: Metrics collection agent
# - vmalert: Alerting and recording rules
# - Grafana: Visualization and dashboards
#
# Usage:
#   task metrics:start  # Start the stack
#   task metrics:stop   # Stop the stack
#   task metrics:logs   # View logs
#
# Access:
#   - Grafana: https://dev-grafana.infra4.dev (admin/admin)
#   - VictoriaMetrics: https://dev-vm.infra4.dev
#   - VictoriaLogs: https://dev-vl.infra4.dev
#   - VictoriaTraces: https://dev-vt.infra4.dev

name: pressograph-victoria

services:
  # ----------------------------------------------------------------------------
  # VictoriaMetrics - Metrics Storage
  # ----------------------------------------------------------------------------
  victoria-metrics:
    image: victoriametrics/victoria-metrics:latest
    container_name: pressograph-victoria-metrics
    ports:
      - "8428:8428"
    volumes:
      - victoria-metrics-data:/victoria-metrics-data
    command:
      - '--storageDataPath=/victoria-metrics-data'
      - '--httpListenAddr=:8428'
      - '--retentionPeriod=12'  # Keep data for 12 months
      - '--search.maxQueryDuration=120s'
      - '--search.maxConcurrentRequests=8'
      - '--memory.allowedPercent=60'  # Limit memory usage
    networks:
      - pressograph-dev
      - traefik-public
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8428/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      # Podman Compose metadata
      io.podman.compose.project: pressograph-victoria
      com.pressograph.service: victoria-metrics

      # Traefik configuration
      traefik.enable: "true"
      traefik.docker.network: traefik-public

      # HTTPS Router
      traefik.http.routers.victoria-metrics-dev.rule: Host(`dev-vm.infra4.dev`)
      traefik.http.routers.victoria-metrics-dev.entrypoints: https
      traefik.http.routers.victoria-metrics-dev.tls: "true"
      traefik.http.routers.victoria-metrics-dev.tls.certresolver: cloudflare
      traefik.http.routers.victoria-metrics-dev.middlewares: web-development@file
      traefik.http.routers.victoria-metrics-dev.service: victoria-metrics-dev

      # Service configuration
      traefik.http.services.victoria-metrics-dev.loadbalancer.server.port: "8428"

  # ----------------------------------------------------------------------------
  # VictoriaLogs - Log Storage
  # ----------------------------------------------------------------------------
  victoria-logs:
    image: victoriametrics/victoria-logs:latest
    container_name: pressograph-victoria-logs
    ports:
      - "9428:9428"
    volumes:
      - victoria-logs-data:/victoria-logs-data
    command:
      - '--storageDataPath=/victoria-logs-data'
      - '--httpListenAddr=:9428'
      - '--retentionPeriod=3'  # Keep logs for 3 months
    networks:
      - pressograph-dev
      - traefik-public
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:9428/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      # Podman Compose metadata
      io.podman.compose.project: pressograph-victoria
      com.pressograph.service: victoria-logs

      # Traefik configuration
      traefik.enable: "true"
      traefik.docker.network: traefik-public

      # HTTPS Router
      traefik.http.routers.victoria-logs-dev.rule: Host(`dev-vl.infra4.dev`)
      traefik.http.routers.victoria-logs-dev.entrypoints: https
      traefik.http.routers.victoria-logs-dev.tls: "true"
      traefik.http.routers.victoria-logs-dev.tls.certresolver: cloudflare
      traefik.http.routers.victoria-logs-dev.middlewares: web-development@file
      traefik.http.routers.victoria-logs-dev.service: victoria-logs-dev

      # Service configuration
      traefik.http.services.victoria-logs-dev.loadbalancer.server.port: "9428"

  # ----------------------------------------------------------------------------
  # VictoriaTraces - Distributed Tracing (OpenTelemetry)
  # ----------------------------------------------------------------------------
  victoria-traces:
    image: victoriametrics/victoria-traces:latest
    container_name: pressograph-victoria-traces
    ports:
      - "4318:4318"  # OTLP HTTP receiver
      - "4317:4317"  # OTLP gRPC receiver
      - "9411:9411"  # Zipkin receiver
      - "14268:14268"  # Jaeger receiver
    volumes:
      - victoria-traces-data:/victoria-traces-data
    command:
      - '--storageDataPath=/victoria-traces-data'
      - '--httpListenAddr=:8428'
      - '--otlpHTTPListenAddr=:4318'
      - '--otlpGRPCListenAddr=:4317'
      - '--zipkinListenAddr=:9411'
      - '--jaegerListenAddr=:14268'
      - '--retentionPeriod=1'  # Keep traces for 1 month
    networks:
      - pressograph-dev
      - traefik-public
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8428/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      # Podman Compose metadata
      io.podman.compose.project: pressograph-victoria
      com.pressograph.service: victoria-traces

      # Traefik configuration
      traefik.enable: "true"
      traefik.docker.network: traefik-public

      # HTTPS Router for UI
      traefik.http.routers.victoria-traces-dev.rule: Host(`dev-vt.infra4.dev`)
      traefik.http.routers.victoria-traces-dev.entrypoints: https
      traefik.http.routers.victoria-traces-dev.tls: "true"
      traefik.http.routers.victoria-traces-dev.tls.certresolver: cloudflare
      traefik.http.routers.victoria-traces-dev.middlewares: web-development@file
      traefik.http.routers.victoria-traces-dev.service: victoria-traces-dev

      # Service configuration
      traefik.http.services.victoria-traces-dev.loadbalancer.server.port: "8428"

  # ----------------------------------------------------------------------------
  # vmagent - Metrics Collection Agent
  # ----------------------------------------------------------------------------
  vmagent:
    image: victoriametrics/vmagent:latest
    container_name: pressograph-vmagent
    ports:
      - "8429:8429"
    volumes:
      - vmagent-data:/vmagentdata
      - ./victoria/vmagent-config.yml:/etc/vmagent/vmagent.yml:ro
    command:
      - '--promscrape.config=/etc/vmagent/vmagent.yml'
      - '--remoteWrite.url=http://victoria-metrics:8428/api/v1/write'
      - '--httpListenAddr=:8429'
    networks:
      - pressograph-dev
    restart: unless-stopped
    depends_on:
      - victoria-metrics
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8429/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      io.podman.compose.project: pressograph-victoria
      com.pressograph.service: vmagent

  # ----------------------------------------------------------------------------
  # vmalert - Alerting and Recording Rules
  # ----------------------------------------------------------------------------
  vmalert:
    image: victoriametrics/vmalert:latest
    container_name: pressograph-vmalert
    ports:
      - "8880:8880"
    volumes:
      - ./victoria/vmalert-rules.yml:/etc/vmalert/rules.yml:ro
    command:
      - '--datasource.url=http://victoria-metrics:8428'
      - '--remoteWrite.url=http://victoria-metrics:8428'
      - '--remoteRead.url=http://victoria-metrics:8428'
      - '--rule=/etc/vmalert/rules.yml'
      - '--httpListenAddr=:8880'
      - '--evaluationInterval=15s'
    networks:
      - pressograph-dev
    restart: unless-stopped
    depends_on:
      - victoria-metrics
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8880/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      io.podman.compose.project: pressograph-victoria
      com.pressograph.service: vmalert

  # ----------------------------------------------------------------------------
  # Grafana - Visualization Platform
  # ----------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: pressograph-grafana
    user: "472:472"  # Non-root user (grafana:grafana)
    ports:
      - "3001:3000"
    environment:
      # Security
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ALLOW_EMBEDDING=true
      - GF_SECURITY_COOKIE_SECURE=true
      - GF_SECURITY_COOKIE_SAMESITE=lax

      # Server settings
      - GF_SERVER_ROOT_URL=https://dev-grafana.infra4.dev
      - GF_SERVER_DOMAIN=dev-grafana.infra4.dev
      - GF_SERVER_ENABLE_GZIP=true

      # Database (use SQLite for simplicity)
      - GF_DATABASE_TYPE=sqlite3
      - GF_DATABASE_PATH=/var/lib/grafana/grafana.db

      # Plugins
      - GF_INSTALL_PLUGINS=grafana-piechart-panel,grafana-clock-panel

      # Analytics (disable for privacy)
      - GF_ANALYTICS_REPORTING_ENABLED=false
      - GF_ANALYTICS_CHECK_FOR_UPDATES=false
      - GF_ANALYTICS_CHECK_FOR_PLUGIN_UPDATES=false

      # Anonymous access (disabled - require login)
      - GF_AUTH_ANONYMOUS_ENABLED=false

      # Logging
      - GF_LOG_MODE=console
      - GF_LOG_LEVEL=info

      # Unified alerting
      - GF_UNIFIED_ALERTING_ENABLED=true
      - GF_ALERTING_ENABLED=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./victoria/grafana/provisioning:/etc/grafana/provisioning:ro
    networks:
      - pressograph-dev
      - traefik-public
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - victoria-metrics
      - victoria-logs
      - victoria-traces
    labels:
      # Podman Compose metadata
      io.podman.compose.project: pressograph-victoria
      com.pressograph.service: grafana

      # Traefik configuration
      traefik.enable: "true"
      traefik.docker.network: traefik-public

      # HTTPS Router
      traefik.http.routers.grafana-dev.rule: Host(`dev-grafana.infra4.dev`)
      traefik.http.routers.grafana-dev.entrypoints: https
      traefik.http.routers.grafana-dev.tls: "true"
      traefik.http.routers.grafana-dev.tls.certresolver: cloudflare
      traefik.http.routers.grafana-dev.middlewares: web-development@file
      traefik.http.routers.grafana-dev.service: grafana-dev

      # Service configuration
      traefik.http.services.grafana-dev.loadbalancer.server.port: "3000"

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  victoria-metrics-data:
    name: pressograph-victoria-metrics-data
    driver: local
  victoria-logs-data:
    name: pressograph-victoria-logs-data
    driver: local
  victoria-traces-data:
    name: pressograph-victoria-traces-data
    driver: local
  vmagent-data:
    name: pressograph-vmagent-data
    driver: local
  grafana-data:
    name: pressograph-grafana-data
    driver: local

# ==============================================================================
# Networks
# ==============================================================================
networks:
  pressograph-dev:
    external: true
    name: pressograph-dev-network
  traefik-public:
    external: true
    name: traefik-public
